name: Python Build, Test, and Update Tag with Jenkins Build Number

on:
  workflow_run:
    workflows:
      - Trigger Jenkins Build and Update Build Numbers
    types:
      - completed
    conclusion: success

env:
  JENKINS_URL: ${{ secrets.JENKINS_URL }}
  JENKINS_USER: ${{ secrets.JENKINS_USER }}
  JENKINS_API_TOKEN: ${{ secrets.JENKINS_API_TOKEN }}

jobs:
  build-and-tag:
    runs-on: self-hosted

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set Job Name from config.json
        id: set_job_name
        run: |
          JOB_NAME=$(jq -r '.buildConfig.jobName' config.json)
          echo "JOB_NAME=${JOB_NAME}" >> $GITHUB_ENV

      - name: Pull Latest Changes and Handle Conflicts
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ secrets.GIT_EMAIL }}"
          git config --global commit.gpgSign true
          git config --global user.signingkey "${{ secrets.GPG_KEY_ID }}"

          git stash || echo "Nothing to stash"
          git pull origin main --rebase || {
            echo "Merge conflict detected. Resolving automatically using 'theirs'."
            git checkout --theirs .
            git add .
            git rebase --continue || {
              git rebase --abort
              exit 1
            }
          }
          git stash pop || echo "No stashed changes to apply"

      - name: Get Latest Jenkins Build Number
        id: get_jenkins_build_number
        run: |
          set -o pipefail

          RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
            -u "${{ secrets.JENKINS_USER }}:${{ secrets.JENKINS_API_TOKEN }}" \
            "${{ secrets.JENKINS_URL }}/job/${{ env.JOB_NAME }}/lastSuccessfulBuild/buildNumber")

          HTTP_STATUS=$(echo "$RESPONSE" | tail -n1 | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status: $HTTP_STATUS"

          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "Jenkins API failed."
            echo "Response:"
            echo "$BODY"
            exit 1
          fi

          BUILD_NUMBER=$(echo "$BODY" | tr -d '[:space:]')

          if [ -z "$BUILD_NUMBER" ]; then
            echo "No successful build found. Defaulting to 0."
            BUILD_NUMBER=0
          fi

          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV

      - name: Determine Version
        id: determine_version
        run: |
          PATCH=$((BUILD_NUMBER % 10))
          MINOR=$((BUILD_NUMBER / 10 % 6))
          MAJOR=$((BUILD_NUMBER / 60))
          VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "Determined Version: $VERSION"

      - name: Install Dependencies
        run: |
          python3 -m venv venv
          source venv/bin/activate
          pip install -r requirements.txt

      - name: Run Tests
        run: |
          # source venv/bin/activate
          # pytest --junitxml=build/test-results.xml

      - name: Save Changes to Repo (Without Artifacts)
        run: |
          git add .
          git commit -S -m "Add updated version ${{ env.VERSION }}" || echo "No changes to commit"

      - name: Create and Push Tag
        run: |
          TAG_NAME="${{ env.VERSION }}"
          echo "Incremented the TAG version: $TAG_NAME"
          git tag -a -f "$TAG_NAME" -m "$TAG_NAME"
          git push origin --force "$TAG_NAME"

      - name: Push Changes
        run: |
          git push origin main
